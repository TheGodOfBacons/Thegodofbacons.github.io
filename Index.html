<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Basic FPS Prototype</title>
<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden; height: 100%;
    background: #87ceeb;
    font-family: Arial, sans-serif;
  }
  #overlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.7);
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2em;
    cursor: pointer;
    user-select: none;
    z-index: 10000;
  }
  #hud {
    position: fixed;
    top: 10px; left: 10px;
    color: white;
    font-size: 1.2em;
    z-index: 10001;
  }
</style>
</head>
<body>
<div id="overlay">Click to start</div>
<div id="hud">Weapon: Pistol (Press 1-3 to switch)</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/controls/PointerLockControls.js"></script>

<script>
  const overlay = document.getElementById('overlay');
  const hud = document.getElementById('hud');

  let scene, camera, renderer, controls;
  let velocity = new THREE.Vector3();
  let direction = new THREE.Vector3();
  let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
  let canJump = false;
  const clock = new THREE.Clock();

  // Weapons: pistol, AR, grenade
  const weapons = [
    {name: "Pistol", fireRate: 500, damage: 20},
    {name: "AR", fireRate: 200, damage: 10},
    {name: "Grenade", fireRate: 1000, damage: 50}
  ];
  let currentWeapon = 0;
  let lastShotTime = 0;

  const npcs = [];

  init();

  function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 2, 5);

    // Lights
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444);
    hemiLight.position.set(0, 20, 0);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xffffff);
    dirLight.position.set(3, 10, 10);
    scene.add(dirLight);

    // Ground
    const groundGeo = new THREE.PlaneGeometry(100, 100);
    const groundMat = new THREE.MeshPhongMaterial({color: 0x444444});
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = - Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Obstacles (boxes)
    const boxGeo = new THREE.BoxGeometry(2, 2, 2);
    const boxMat = new THREE.MeshPhongMaterial({color: 0x888888});
    for(let i=0; i<10; i++) {
      let box = new THREE.Mesh(boxGeo, boxMat);
      box.position.set((Math.random()-0.5)*80,1, (Math.random()-0.5)*80);
      box.castShadow = true;
      scene.add(box);
    }

    // NPCs (red cubes)
    const npcGeo = new THREE.BoxGeometry(1, 2, 1);
    const npcMat = new THREE.MeshPhongMaterial({color: 0xff4444});
    for(let i=0; i<5; i++) {
      let npc = new THREE.Mesh(npcGeo, npcMat.clone());
      npc.position.set((Math.random()-0.5)*80, 1, (Math.random()-0.5)*80);
      npc.userData.alive = true;
      scene.add(npc);
      npcs.push(npc);
    }

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    controls = new THREE.PointerLockControls(camera, document.body);
    scene.add(controls.getObject());

    // Pointer lock overlay logic
    document.body.addEventListener('click', () => {
      if(!controls.isLocked) controls.lock();
    });

    controls.addEventListener('lock', () => {
      overlay.style.display = 'none';
    });
    controls.addEventListener('unlock', () => {
      overlay.style.display = 'flex';
    });

    // Movement controls
    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup', onKeyUp);
    document.addEventListener('mousedown', onMouseDown);
    window.addEventListener('resize', onWindowResize);
    document.addEventListener('keypress', onKeyPress);

    animate();
  }

  function onKeyPress(e) {
    // Switch weapons with keys 1,2,3
    if(e.key >= '1' && e.key <= '3') {
      currentWeapon = e.key - '1';
      hud.textContent = `Weapon: ${weapons[currentWeapon].name} (Press 1-3 to switch)`;
    }
  }

  function onMouseDown(e) {
    if(e.button === 0 && controls.isLocked) {
      shoot();
    }
  }

  function shoot() {
    const now = performance.now();
    if(now - lastShotTime < weapons[currentWeapon].fireRate) return; // fire rate limiter
    lastShotTime = now;

    // Raycast from center of screen
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);

    // Check NPC hits
    const hits = raycaster.intersectObjects(npcs.filter(n => n.userData.alive));
    if(hits.length > 0) {
      const npc = hits[0].object;
      npc.userData.health = (npc.userData.health || 100) - weapons[currentWeapon].damage;
      if(npc.userData.health <= 0) {
        npc.userData.alive = false;
        npc.material.color.set(0x333333);
        // Simple ragdoll effect - fall down
        npc.rotation.x = Math.PI / 2;
      }
    }

    // TODO: Add grenade explosion if grenade selected
  }

  function onKeyDown(e) {
    switch(e.code) {
      case 'ArrowUp':
      case 'KeyW':
        moveForward = true;
        break;
      case 'ArrowLeft':
      case 'KeyA':
        moveLeft = true;
        break;
      case 'ArrowDown':
      case 'KeyS':
        moveBackward = true;
        break;
      case 'ArrowRight':
      case 'KeyD':
        moveRight = true;
        break;
      case 'Space':
        if(canJump) velocity.y += 8;
        canJump = false;
        break;
    }
  }

  function onKeyUp(e) {
    switch(e.code) {
      case 'ArrowUp':
      case 'KeyW':
        moveForward = false;
        break;
      case 'ArrowLeft':
      case 'KeyA':
        moveLeft = false;
        break;
      case 'ArrowDown':
      case 'KeyS':
        moveBackward = false;
        break;
      case 'ArrowRight':
      case 'KeyD':
        moveRight = false;
        break;
    }
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function animate() {
    requestAnimationFrame(animate);

    const delta = clock.getDelta();

    if(controls.isLocked) {
      velocity.x -= velocity.x * 10.0 * delta;
      velocity.z -= velocity.z * 10.0 * delta;
      velocity.y -= 9.8 * 10.0 * delta;

      direction.z = Number(moveForward) - Number(moveBackward);
      direction.x = Number(moveRight) - Number(moveLeft);
      direction.normalize();

      if(moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
      if(moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

      controls.moveRight(-velocity.x * delta);
      controls.moveForward(-velocity.z * delta);

      controls.getObject().position.y += velocity.y * delta;

      if(controls.getObject().position.y < 1.5) {
        velocity.y = 0;
        controls.getObject().position.y = 1.5;
        canJump = true;
      }

      // Basic NPC "ragdoll" fall on death
      npcs.forEach(npc => {
        if(!npc.userData.alive) {
          npc.rotation.x += delta * 5;
          if(npc.position.y > 0) {
            npc.position.y -= delta * 3;
            if(npc.position.y < 0) npc.position.y = 0;
          }
        }
      });
    }

    renderer.render(scene, camera);
  }
</script>
</body>
</html>
